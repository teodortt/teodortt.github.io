<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4f46e5" id="themeColor">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>BG Euro Hub</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            --card-bg: #ffffff;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --accent: #4f46e5;
            --accent-soft: #eef2ff;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #111827 0%, #1f2937 100%);
            --card-bg: #1f2937;
            --text-main: #f9fafb;
            --text-sec: #9ca3af;
            --accent: #818cf8;
            --accent-soft: #312e81;
            --border: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            color: var(--text-main);
        }

        .container {
            width: 100%;
            max-width: 480px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
            max-height: 850px;
        }

        .header { padding: 20px 20px 10px; display: flex; justify-content: space-between; align-items: center; }
        .title { font-weight: 800; font-size: 1.25rem; display: flex; align-items: center; gap: 8px; }
        .theme-btn { background: none; border: none; cursor: pointer; color: var(--text-main); padding: 8px; border-radius: 50%; background: var(--border); }

        .tabs { display: flex; padding: 0 16px; gap: 8px; margin-bottom: 16px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: var(--text-sec); font-weight: 600; border-bottom: 2px solid transparent; cursor: pointer; transition: all 0.2s; white-space: nowrap; font-size: 0.9rem; }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); background: var(--accent-soft); border-radius: 8px 8px 0 0; }

        .content-area { flex: 1; overflow-y: auto; padding: 0 20px 20px; display: none; }
        .content-area.active { display: block; animation: fadeIn 0.3s ease; }

        .input-wrapper { position: relative; margin-bottom: 16px; }
        .label { font-size: 0.85rem; color: var(--text-sec); margin-bottom: 6px; display: block; font-weight: 500; }
        .input-field { width: 100%; padding: 16px; font-size: 1.25rem; background: var(--bg-gradient); border: 1px solid var(--border); border-radius: 12px; color: var(--text-main); font-weight: 700; outline: none; }
        .input-text { font-size: 1rem; font-weight: 500; }
        .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        .currency-badge { position: absolute; right: 16px; top: 42px; font-weight: 700; color: var(--text-sec); }

        .card-section { background: var(--bg-gradient); padding: 16px; border-radius: 12px; margin-top: 20px; border: 1px solid var(--border); }

        .history-list { margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .history-item { padding: 12px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .history-item:last-child { border: none; }
        .history-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .history-note { font-weight: 600; color: var(--text-main); }
        .history-time { font-size: 0.75rem; color: var(--text-sec); }
        .history-details { display: flex; justify-content: space-between; color: var(--text-sec); font-size: 0.85rem; }
        .history-highlight { color: var(--accent); font-weight: 600; }

        .payment-summary { text-align: center; padding: 20px; border-radius: 16px; margin-top: 20px; background: var(--text-main); color: var(--card-bg); }
        .change-amount { font-size: 2.5rem; font-weight: 800; margin: 10px 0; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .status-ok { background: var(--success); color: white; }
        .status-warn { background: var(--danger); color: white; }

        .btn-row { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: opacity 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--text-main); }
        .btn-clear { color: var(--danger); font-size: 0.8rem; cursor: pointer; }

        /* Scanner Upgrades */
        #video-container { width: 100%; height: 280px; background: #000; border-radius: 12px; overflow: hidden; position: relative; margin-bottom: 16px; }
        video, #previewImg { width: 100%; height: 100%; object-fit: contain; }
        #previewImg { display: none; }
        
        #fileInput { display: none; }
        
        .progress-container { background: var(--border); height: 8px; border-radius: 10px; overflow: hidden; margin: 16px 0; display: none; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .progress-text { text-align: center; color: var(--text-sec); font-size: 0.85rem; margin-top: 8px; }

        .receipt-data { background: var(--bg-gradient); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-top: 16px; display: none; }
        .receipt-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .receipt-row:last-child { border: none; }
        .receipt-row.total { font-weight: 700; font-size: 1.1rem; color: var(--accent); }
        .receipt-item { margin-bottom: 8px; }
        .receipt-item-name { color: var(--text-sec); font-size: 0.85rem; }
        .receipt-item-price { font-weight: 600; color: var(--text-main); }

        .swap-container { display: flex; justify-content: center; margin: -10px 0 10px; position: relative; z-index: 5; }
        .swap-btn { background: var(--accent); color: white; width: 40px; height: 40px; border-radius: 50%; border: 4px solid var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">
            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/><path d="M12 18V6"/></svg>
            BG Euro Hub
        </div>
        <button class="theme-btn" onclick="toggleTheme()">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </button>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('converter')">–ö–æ–Ω–≤–µ—Ä—Ç–æ—Ä</button>
        <button class="tab-btn" onclick="switchTab('payment')">–ö–∞—Å–∞ / –†–µ—Å—Ç–æ</button>
        <button class="tab-btn" onclick="switchTab('scanner')">üì∏ –°–∫–µ–Ω–µ—Ä</button>
    </div>

    <!-- TAB 1: CONVERTER -->
    <div id="converter" class="content-area active">
        <div class="input-wrapper">
            <label class="label" id="lblTop">–°—É–º–∞ –≤ –ï–≤—Ä–æ</label>
            <input type="number" id="inpTop" class="input-field" placeholder="0" inputmode="decimal" value="100">
            <span class="currency-badge" id="curTop">EUR</span>
        </div>
        <div class="swap-container">
            <div class="swap-btn" onclick="swapConverter()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M7 16V4M7 4L3 8M7 4L11 8M17 8V20M17 20L21 16M17 20L13 16"/></svg>
            </div>
        </div>
        <div class="input-wrapper">
            <label class="label" id="lblBottom">–°—É–º–∞ –≤ –õ–µ–≤–∞</label>
            <input type="number" id="inpBottom" class="input-field" placeholder="0" inputmode="decimal" readonly>
            <span class="currency-badge" id="curBottom">BGN</span>
        </div>
        <div class="btn-row">
            <button class="btn btn-outline" onclick="copyResult()">–ö–æ–ø–∏—Ä–∞–π</button>
            <button class="btn btn-primary" onclick="saveToHistory()">–ó–∞–ø–∞–∑–∏</button>
        </div>
        <div class="card-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span class="label" style="margin:0;">üìú –ò—Å—Ç–æ—Ä–∏—è (–ö–æ–Ω–≤–µ—Ä—Ç–æ—Ä)</span>
                <span class="btn-clear" onclick="clearHistory()">–ò–∑—á–∏—Å—Ç–∏</span>
            </div>
            <div id="historyList" class="history-list"></div>
        </div>
    </div>

    <!-- TAB 2: PAYMENT -->
    <div id="payment" class="content-area">
        <div class="input-wrapper">
            <label class="label">–ò–º–µ / –ë–µ–ª–µ–∂–∫–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</label>
            <input type="text" id="payNote" class="input-field input-text" placeholder="–ù–∞–ø—Ä. –ú–∞—Å–∞ 5 –∏–ª–∏ –ü–æ—Ä—ä—á–∫–∞ 12">
        </div>
        <div class="input-wrapper">
            <label class="label">–î—ä–ª–∂–∏–º–∞ —Å—É–º–∞ (–°–º–µ—Ç–∫–∞)</label>
            <input type="number" id="billAmount" class="input-field" placeholder="0.00" inputmode="decimal">
            <span class="currency-badge">BGN</span>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="input-wrapper" style="flex:1;">
                <label class="label">–î–∞–≤–∞—Ç (EUR)</label>
                <input type="number" id="payEur" class="input-field" placeholder="0" inputmode="decimal">
            </div>
            <div class="input-wrapper" style="flex:1;">
                <label class="label">–î–∞–≤–∞—Ç (BGN)</label>
                <input type="number" id="payBgn" class="input-field" placeholder="0" inputmode="decimal">
            </div>
        </div>
        <div class="payment-summary" id="paymentResult">
            <div id="paymentStatus" class="status-badge status-warn">–ß–∞–∫–∞ –≤—ä–≤–µ–∂–¥–∞–Ω–µ</div>
            <div style="margin-top:10px; font-size:0.9rem; opacity:0.8;">–†–µ—Å—Ç–æ –∑–∞ –≤—Ä—ä—â–∞–Ω–µ:</div>
            <div class="change-amount" id="changeBgn">0.00 <span style="font-size:1rem">–ª–≤</span></div>
            <div style="font-size:0.9rem;">‚âà <span id="changeEur">0.00</span> ‚Ç¨</div>
        </div>
        <div class="btn-row">
             <button class="btn btn-outline" onclick="resetPayment()">–ù–æ–≤–∞</button>
             <button class="btn btn-primary" onclick="savePayment()">–ó–∞–ø–∞–∑–∏</button>
        </div>
        <div class="card-section">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span class="label" style="margin:0;">üõí –ò—Å—Ç–æ—Ä–∏—è (–ö–∞—Å–∞)</span>
                <span class="btn-clear" onclick="clearPaymentHistory()">–ò–∑—á–∏—Å—Ç–∏</span>
            </div>
            <div id="paymentHistoryList" class="history-list"></div>
        </div>
    </div>

    <!-- TAB 3: SCANNER (COMPLETELY REDESIGNED) -->
    <div id="scanner" class="content-area">
        <p class="label" style="text-align:center; margin-bottom:12px;">–°–Ω–∏–º–∞–π –±–µ–ª–µ–∂–∫–∞—Ç–∞ —Å –¥–æ–±—Ä–æ –æ—Å–≤–µ—Ç–ª–µ–Ω–∏–µ</p>
        
        <div id="video-container">
            <video id="video" playsinline autoplay></video>
            <img id="previewImg" />
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">

        <div class="btn-row">
            <button class="btn btn-outline" id="btnCamera" onclick="startCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
            <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">üìÅ –ö–∞—á–∏ —Å–Ω–∏–º–∫–∞</button>
        </div>
        
        <button class="btn btn-primary" id="btnScan" onclick="scanReceipt()" disabled style="width:100%; margin-top:10px;">
            –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –±–µ–ª–µ–∂–∫–∞—Ç–∞
        </button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <p class="progress-text" id="progressText"></p>

        <div class="receipt-data" id="receiptData">
            <h3 style="margin-bottom:12px; color:var(--text-main);">üìã –†–µ–∑—É–ª—Ç–∞—Ç–∏ –æ—Ç –±–µ–ª–µ–∂–∫–∞—Ç–∞</h3>
            <div id="receiptContent"></div>
            <div class="btn-row" style="margin-top:16px;">
                <button class="btn btn-primary" onclick="useTotal()">–ò–∑–ø–æ–ª–∑–≤–∞–π —Ç–æ—Ç–∞–ª</button>
            </div>
        </div>
    </div>

</div>

<script>
    const RATE = 1.95583;
    let isEurToBgn = true;
    
    function init() {
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('themeColor').setAttribute('content', '#111827');
        }
        renderHistory();
        renderPaymentHistory();
        calcConverter();
    }

    function toggleTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const newTheme = isDark ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.theme = newTheme;
        document.getElementById('themeColor').setAttribute('content', newTheme === 'dark' ? '#111827' : '#4f46e5');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.content-area').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId === 'converter') btns[0].classList.add('active');
        else if(tabId === 'payment') btns[1].classList.add('active');
        else btns[2].classList.add('active');
        
        if(tabId !== 'scanner') {
            stopCamera();
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('video').style.display = 'block';
        }
    }

    // CONVERTER (unchanged)
    const inpTop = document.getElementById('inpTop');
    const inpBottom = document.getElementById('inpBottom');
    function calcConverter() {
        const val = parseFloat(inpTop.value);
        if (isNaN(val)) { inpBottom.value = ''; return; }
        const res = isEurToBgn ? val * RATE : val / RATE;
        inpBottom.value = res.toFixed(2);
    }
    function swapConverter() {
        isEurToBgn = !isEurToBgn;
        document.getElementById('lblTop').innerText = isEurToBgn ? '–°—É–º–∞ –≤ –ï–≤—Ä–æ' : '–°—É–º–∞ –≤ –õ–µ–≤–∞';
        document.getElementById('lblBottom').innerText = isEurToBgn ? '–°—É–º–∞ –≤ –õ–µ–≤–∞' : '–°—É–º–∞ –≤ –ï–≤—Ä–æ';
        document.getElementById('curTop').innerText = isEurToBgn ? 'EUR' : 'BGN';
        document.getElementById('curBottom').innerText = isEurToBgn ? 'BGN' : 'EUR';
        inpTop.value = inpBottom.value;
        calcConverter();
    }
    inpTop.addEventListener('input', calcConverter);
    function saveToHistory() {
        const h = JSON.parse(localStorage.getItem('calcHistory') || '[]');
        h.unshift({ txt: `${inpTop.value} ${document.getElementById('curTop').innerText} ‚ûù ${inpBottom.value} ${document.getElementById('curBottom').innerText}`, time: new Date().toLocaleTimeString('bg-BG', {hour:'2-digit',minute:'2-digit'}) });
        if(h.length > 10) h.pop();
        localStorage.setItem('calcHistory', JSON.stringify(h));
        renderHistory();
    }
    function renderHistory() {
        document.getElementById('historyList').innerHTML = JSON.parse(localStorage.getItem('calcHistory') || '[]')
            .map(h => `<div class="history-item"><div class="history-top"><span>${h.txt}</span><span class="history-time">${h.time}</span></div></div>`).join('') || '<div style="text-align:center;color:var(--text-sec);padding:10px;">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏</div>';
    }
    function clearHistory() { localStorage.removeItem('calcHistory'); renderHistory(); }
    function copyResult() { navigator.clipboard.writeText(`${inpBottom.value} ${document.getElementById('curBottom').innerText}`); }

    // PAYMENT (unchanged)
    const billInput = document.getElementById('billAmount');
    const payEurInput = document.getElementById('payEur');
    const payBgnInput = document.getElementById('payBgn');
    function calcPayment() {
        const bill = parseFloat(billInput.value) || 0;
        const paid = (parseFloat(payBgnInput.value)||0) + ((parseFloat(payEurInput.value)||0) * RATE);
        const change = paid - bill;
        const status = document.getElementById('paymentStatus');
        if (bill > 0 && change >= -0.01) {
            status.innerText = "–†–ï–°–¢–û"; status.className = "status-badge status-ok";
            document.getElementById('paymentResult').style.background = "var(--text-main)";
        } else {
            status.innerText = "–û–°–¢–ê–í–ê–¢"; status.className = "status-badge status-warn";
            document.getElementById('paymentResult').style.background = document.documentElement.getAttribute('data-theme') === 'dark' ? "#7f1d1d" : "#fee2e2";
        }
        document.getElementById('changeBgn').innerText = Math.abs(change).toFixed(2) + " –ª–≤";
        document.getElementById('changeEur').innerText = Math.abs(change / RATE).toFixed(2);
    }
    function savePayment() {
        const h = JSON.parse(localStorage.getItem('payHistory') || '[]');
        h.unshift({ note: document.getElementById('payNote').value || '–°–º–µ—Ç–∫–∞', bill: billInput.value, change: document.getElementById('changeBgn').innerText, time: new Date().toLocaleTimeString('bg-BG', {hour:'2-digit',minute:'2-digit'}) });
        if(h.length > 20) h.pop();
        localStorage.setItem('payHistory', JSON.stringify(h));
        renderPaymentHistory();
    }
    function renderPaymentHistory() {
        document.getElementById('paymentHistoryList').innerHTML = JSON.parse(localStorage.getItem('payHistory') || '[]')
            .map(h => `<div class="history-item"><div class="history-top"><span class="history-note">${h.note}</span><span class="history-time">${h.time}</span></div><div class="history-details"><span>–°–º–µ—Ç–∫–∞: ${h.bill} –ª–≤</span><span class="history-highlight">–†–µ—Å—Ç–æ: ${h.change}</span></div></div>`).join('') || '<div style="text-align:center;color:var(--text-sec);padding:10px;">–ù—è–º–∞ –∑–∞–ø–∏—Å–∏</div>';
    }
    function clearPaymentHistory() { localStorage.removeItem('payHistory'); renderPaymentHistory(); }
    function resetPayment() { billInput.value=''; payEurInput.value=''; payBgnInput.value=''; document.getElementById('payNote').value=''; calcPayment(); }
    [billInput, payEurInput, payBgnInput].forEach(el => el.addEventListener('input', calcPayment));

    // ===== SCANNER (COMPLETELY NEW) =====
    let stream = null;
    let scanMode = 'camera';
    let scannedTotal = 0;

    async function startCamera() {
        document.getElementById('previewImg').style.display = 'none';
        document.getElementById('video').style.display = 'block';
        scanMode = 'camera';
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            document.getElementById('video').srcObject = stream;
            document.getElementById('btnScan').disabled = false;
        } catch (err) { alert("–†–∞–∑—Ä–µ—à–µ—Ç–µ –∫–∞–º–µ—Ä–∞—Ç–∞"); }
    }

    function stopCamera() {
        if(stream) stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        stopCamera();
        scanMode = 'file';
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = document.getElementById('previewImg');
            img.src = event.target.result;
            img.style.display = 'block';
            document.getElementById('video').style.display = 'none';
            document.getElementById('btnScan').disabled = false;
        };
        reader.readAsDataURL(file);
    }

    // Image Preprocessing
    function preprocessImage(imageSource) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = imageSource.width || imageSource.videoWidth;
            canvas.height = imageSource.height || imageSource.videoHeight;
            
            // Draw original
            ctx.drawImage(imageSource, 0, 0, canvas.width, canvas.height);
            
            // Get image data
            let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let data = imgData.data;
            
            // Grayscale + Contrast Boost
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                // Increase contrast
                const contrasted = ((gray - 128) * 1.5) + 128;
                data[i] = data[i + 1] = data[i + 2] = Math.max(0, Math.min(255, contrasted));
            }
            
            ctx.putImageData(imgData, 0, 0);
            resolve(canvas);
        });
    }

    async function scanReceipt() {
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const receiptData = document.getElementById('receiptData');
        const receiptContent = document.getElementById('receiptContent');
        
        progressContainer.style.display = 'block';
        receiptData.style.display = 'none';
        progressBar.style.width = '0%';
        progressText.innerText = '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...';

        let imageSource;
        if (scanMode === 'camera') {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            imageSource = canvas;
        } else {
            imageSource = document.getElementById('previewImg');
        }

        // Preprocess
        progressText.innerText = '–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ...';
        progressBar.style.width = '20%';
        const processed = await preprocessImage(imageSource);

        // OCR
        progressText.innerText = '–†–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ –Ω–∞ —Ç–µ–∫—Å—Ç (–º–æ–∂–µ –¥–∞ –æ—Ç–Ω–µ–º–µ 10-20 —Å–µ–∫)...';
        progressBar.style.width = '40%';

        try {
            const { data: { text } } = await Tesseract.recognize(processed, 'eng+bul', {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const percent = 40 + (m.progress * 50);
                        progressBar.style.width = percent + '%';
                    }
                }
            });

            progressText.innerText = '–ê–Ω–∞–ª–∏–∑ –Ω–∞ –¥–∞–Ω–Ω–∏...';
            progressBar.style.width = '95%';

            // Parse receipt data
            const parsed = parseReceiptText(text);
            
            progressBar.style.width = '100%';
            progressText.innerText = '–ì–æ—Ç–æ–≤–æ!';
            
            setTimeout(() => {
                progressContainer.style.display = 'none';
                displayReceiptData(parsed);
            }, 500);

        } catch (err) {
            progressContainer.style.display = 'none';
            alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–∞–Ω–µ: ' + err.message);
        }
    }

    function parseReceiptText(text) {
        const lines = text.split('\n').filter(l => l.trim().length > 0);
        
        // Find prices (format: 12.50 or 12,50)
        const priceRegex = /(\d+[.,]\d{2})/g;
        const prices = [];
        const items = [];
        
        lines.forEach(line => {
            const matches = line.match(priceRegex);
            if (matches) {
                matches.forEach(m => prices.push(parseFloat(m.replace(',', '.'))));
                items.push({ name: line, price: matches[0].replace(',', '.') });
            }
        });

        // Try to find TOTAL (last/largest price usually)
        let total = prices.length > 0 ? Math.max(...prices) : 0;
        
        // Try to find VAT/–î–î–°
        const vatMatch = text.match(/(–¥–¥—Å|vat|dds)[:\s]*(\d+[.,]\d{2})/i);
        const vat = vatMatch ? parseFloat(vatMatch[2].replace(',', '.')) : 0;

        // Try to find date
        const dateMatch = text.match(/(\d{1,2}[./-]\d{1,2}[./-]\d{2,4})/);
        const date = dateMatch ? dateMatch[0] : '–ù–µ –µ –æ—Ç–∫—Ä–∏—Ç–∞';

        scannedTotal = total;

        return { total, vat, date, items: items.slice(0, 10), rawText: text };
    }

    function displayReceiptData(data) {
        const receiptData = document.getElementById('receiptData');
        const receiptContent = document.getElementById('receiptContent');
        
        let html = `
            <div class="receipt-row total">
                <span>–¢–û–¢–ê–õ:</span>
                <span>${data.total.toFixed(2)} –ª–≤</span>
            </div>
        `;

        if (data.vat > 0) {
            html += `<div class="receipt-row"><span>–î–î–°:</span><span>${data.vat.toFixed(2)} –ª–≤</span></div>`;
        }

        html += `<div class="receipt-row"><span>–î–∞—Ç–∞:</span><span>${data.date}</span></div>`;

        if (data.items.length > 0) {
            html += `<div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                <p class="label" style="margin-bottom:8px;">–ê—Ä—Ç–∏–∫—É–ª–∏:</p>`;
            data.items.forEach(item => {
                html += `<div class="receipt-item">
                    <div class="receipt-item-name">${item.name.substring(0, 40)}</div>
                </div>`;
            });
            html += `</div>`;
        }

        receiptContent.innerHTML = html;
        receiptData.style.display = 'block';
    }

    function useTotal() {
        if (scannedTotal > 0) {
            switchTab('converter');
            inpTop.value = scannedTotal.toFixed(2);
            calcConverter();
        }
    }

    init();
</script>
</body>
</html>
